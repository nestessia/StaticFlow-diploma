{% extends "base.html" %}

{% block title %}Block Editor{% endblock %}

{% block page_title %}Block Editor{% endblock %}

{% block head %}
<link rel="stylesheet" href="/admin/static/css/block-editor.css">
<style>
    .filename-input-container {
        display: flex;
        margin-bottom: 10px;
    }
    
    #filename-input {
        flex-grow: 1;
        padding: 5px;
        border: 1px solid #ddd;
        border-right: none;
        border-radius: 4px 0 0 4px;
        font-size: 14px;
    }
    
    #file-extension {
        width: auto;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 0 4px 4px 0;
        background-color: #f5f5f5;
        font-size: 14px;
    }
</style>
<!-- KaTeX для математических формул -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<!-- Mermaid для диаграмм -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.2.3/dist/mermaid.min.js"></script>
<!-- Highlight.js для подсветки кода -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js" crossorigin="anonymous" type="text/javascript"></script>

{% endblock %}

{% block content %}
<div class="block-editor-page">
    <div class="editor-header">
        <div class="editor-file-info">
            <input 
                type="text" 
                id="page-title" 
                placeholder="Page Title" 
                value="{{ page.title if page else 'Untitled Page' }}"
            >
            {% if not page %}
            <div class="filename-input-container">
                <input 
                    type="text" 
                    id="filename-input" 
                    placeholder="Имя файла (например: my-page)" 
                    value=""
                >
                <select id="file-extension">
                    <option value=".md" selected>Markdown (.md)</option>
                    <option value=".rst">reStructuredText (.rst)</option>
                    <option value=".adoc">AsciiDoc (.adoc)</option>
                </select>
            </div>
            {% endif %}
            <div class="file-path">{{ page.source_path if page else 'New Page' }}</div>
            {% if page and page.modified %}
            <div class="file-modified">Last modified: <script>document.write(new Date({{ page.modified }} * 1000).toLocaleString())</script></div>
            {% endif %}
        </div>
        <div class="editor-actions">
            <button class="btn" id="save-btn">Save</button>
            <button class="btn btn-secondary" id="preview-btn">Preview</button>
        </div>
    </div>

    <div class="editor-container">
        <!-- Блочный редактор будет инициализирован здесь -->
        <div id="block-editor"></div>
    </div>

    <div class="editor-metadata">
        <h3>Page Metadata</h3>
        <div class="metadata-fields">
            <div class="metadata-field">
                <label for="meta-date">Date</label>
                <input type="datetime-local" id="meta-date" value="{{ page.metadata.date if page and page.metadata else '' }}">
            </div>
            <div class="metadata-field">
                <label for="meta-author">Author</label>
                <input type="text" id="meta-author" value="{{ page.metadata.author if page and page.metadata else '' }}">
            </div>
            <div class="metadata-field">
                <label for="meta-tags">Tags (comma separated)</label>
                <input type="text" id="meta-tags" value="{{ ','.join(page.metadata.tags) if page and page.metadata and page.metadata.tags else '' }}">
            </div>
            <div class="metadata-field">
                <label for="meta-format">Output Format</label>
                <select id="meta-format">
                    <option value="markdown" {% if page and page.metadata and page.metadata.format == "markdown" %}selected{% endif %}>Markdown (.md)</option>
                    <option value="rst" {% if page and page.metadata and page.metadata.format == "rst" %}selected{% endif %}>reStructuredText (.rst)</option>
                    <option value="asciidoc" {% if page and page.metadata and page.metadata.format == "asciidoc" %}selected{% endif %}>AsciiDoc (.adoc)</option>
                </select>
            </div>
            <div class="metadata-field">
                <label for="meta-draft">Draft</label>
                <input type="checkbox" id="meta-draft" {% if page and page.metadata and page.metadata.draft %}checked{% endif %}>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/admin/static/js/block-editor.js"></script>
<script>
// Инициализируем mermaid для диаграмм
mermaid.initialize({ startOnLoad: true });

// Сохраняем данные страницы
var pageData = {
    content: {% if page %}{{ page.content|tojson }}{% else %}null{% endif %},
    path: {% if page %}{{ page.source_path|tojson }}{% else %}"New Page"{% endif %},
    title: {% if safe_metadata and safe_metadata.title %}{{ safe_metadata.title|tojson }}{% else %}"Untitled Page"{% endif %},
    metadata: {
        title: {% if safe_metadata and safe_metadata.title %}{{ safe_metadata.title|tojson }}{% else %}""{% endif %},
        date: {% if safe_metadata and safe_metadata.date %}{{ safe_metadata.date|tojson }}{% else %}""{% endif %},
        author: {% if safe_metadata and safe_metadata.author %}{{ safe_metadata.author|tojson }}{% else %}""{% endif %},
        tags: {% if safe_metadata and safe_metadata.tags %}{{ ','.join(safe_metadata.tags)|tojson }}{% else %}""{% endif %},
        format: {% if safe_metadata and safe_metadata.format %}{{ safe_metadata.format|tojson }}{% else %}"markdown"{% endif %},
        draft: {% if safe_metadata and safe_metadata.draft %}true{% else %}false{% endif %}
    }
};

// Инициализация редактора
document.addEventListener('DOMContentLoaded', function() {
    // Wait for block editor scripts to be fully loaded before initializing
    document.addEventListener('blockEditorLoaded', function() {
        try {
            // Инициализация редактора
            var editor = new BlockEditor('#block-editor', pageData.content);
            
            // Make editor variable accessible to the editor instance
            editor.editor = editor.editorContainer;
            
            // Initialize highlight.js if available
            if (window.hljs) {
                console.log("Initializing highlight.js...");
                try {
                    hljs.configure({
                        languages: ['python', 'javascript', 'typescript', 'css', 'html', 'json', 'bash', 'cpp', 'java', 'csharp', 'php', 'ruby', 'go', 'rust', 'swift']
                    });
                    hljs.highlightAll();
                    console.log("highlight.js initialized successfully.");
                } catch (e) {
                    console.error("Error initializing highlight.js:", e);
                }
            } else {
                console.warn("highlight.js is not available! Make sure to include the library in the page.");
                console.info("Attempting to load highlight.js dynamically...");
                // Add script dynamically if needed
                loadHighlightJs();
            }
            
            // Добавляем обработчики событий для кнопок
            document.getElementById('save-btn').addEventListener('click', function() {
                savePage(editor);
            });
            
            document.getElementById('preview-btn').addEventListener('click', function() {
                previewPage(editor);
            });
            
            // Установка начального формата из метаданных
            if (pageData.metadata.format) {
                document.getElementById('meta-format').value = pageData.metadata.format;
            }
            
            // Обработка клавиатурных сокращений
            document.addEventListener('keydown', function(e) {
                // Ctrl+S или Cmd+S для сохранения
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    savePage(editor);
                }
                
                // Ctrl+P или Cmd+P для предпросмотра
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    previewPage(editor);
                }
            });
            
            // Синхронизация выбора формата вывода с расширением файла
            const formatSelector = document.getElementById('meta-format');
            const fileExtension = document.getElementById('file-extension');
            
            // Обновить расширение файла при изменении формата
            if (formatSelector && fileExtension) {
                formatSelector.addEventListener('change', function() {
                    switch(this.value) {
                        case 'markdown':
                            fileExtension.value = '.md';
                            break;
                        case 'rst':
                            fileExtension.value = '.rst';
                            break;
                        case 'asciidoc':
                            fileExtension.value = '.adoc';
                            break;
                    }
                });
                
                // Обновить формат при изменении расширения файла
                fileExtension.addEventListener('change', function() {
                    switch(this.value) {
                        case '.md':
                            formatSelector.value = 'markdown';
                            break;
                        case '.rst':
                            formatSelector.value = 'rst';
                            break;
                        case '.adoc':
                            formatSelector.value = 'asciidoc';
                            break;
                    }
                });
            }
            
            // Генерировать имя файла из заголовка страницы
            const pageTitleInput = document.getElementById('page-title');
            const filenameInput = document.getElementById('filename-input');
            
            if (pageTitleInput && filenameInput) {
                pageTitleInput.addEventListener('blur', function() {
                    // Если поле имени файла пустое, предложить имя на основе заголовка
                    if (!filenameInput.value.trim()) {
                        // Преобразуем заголовок в имя файла
                        const title = pageTitleInput.value.trim();
                        if (title) {
                            const filename = title
                                .toLowerCase()
                                .replace(/[^a-zA-Z0-9\s-]/g, '') // Удаляем спецсимволы
                                .replace(/\s+/g, '-') // Заменяем пробелы на дефисы
                                .replace(/-+/g, '-'); // Убираем дублирующиеся дефисы
                            
                            filenameInput.value = filename;
                        }
                    }
                });
            }
        } catch (error) {
            console.error("Error initializing editor:", error);
        }
    });
});

// Function to dynamically load highlight.js
function loadHighlightJs() {
    // Check if highlight.js is already being loaded or exists
    if (window.hljs || document.querySelector('script[src*="highlight.js"]')) {
        console.log("highlight.js is already loaded or being loaded");
        return;
    }
    
    console.log("Attempting to load highlight.js dynamically...");
    
    try {
        // Create and add the main script
        const script = document.createElement('script');
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js";
        script.crossOrigin = "anonymous";
        script.type = "text/javascript";
        script.onload = function() {
            console.log("highlight.js loaded successfully");
            
            // Initialize after loading
            if (window.hljs) {
                try {
                    hljs.configure({
                        languages: ['python', 'javascript', 'typescript', 'css', 'html', 'json', 'bash', 'cpp', 'java']
                    });
                    hljs.highlightAll();
                    
                    // Apply highlighting to any code blocks that may already exist
                    const codeBlocks = document.querySelectorAll('pre code');
                    if (codeBlocks.length > 0) {
                        console.log(`Applying highlighting to ${codeBlocks.length} existing code blocks`);
                        codeBlocks.forEach(block => {
                            try {
                                hljs.highlightElement(block);
                            } catch (e) {
                                console.warn("Failed to highlight code block:", e);
                            }
                        });
                    }
                    
                    // Success message
                    console.info("highlight.js is now available!");
                } catch (e) {
                    console.error("Error initializing highlight.js after loading:", e);
                }
            } else {
                console.warn("highlight.js still not available after loading script!");
            }
        };
        script.onerror = function(e) {
            console.error("Failed to load highlight.js:", e);
        };
        
        // Create and add the CSS
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css";
        link.crossOrigin = "anonymous";
        
        // Append to document
        document.head.appendChild(link);
        document.head.appendChild(script);
    } catch (e) {
        console.error("Error during dynamic loading of highlight.js:", e);
    }
}

// Format the date in ISO format compatible with datetime-local input
function formatDateForISO(dateValue) {
    let formattedDate;
    if (dateValue) {
        // Parse the date and ensure correct ISO format with 'T' separator
        const date = new Date(dateValue);
        formattedDate = date.toISOString().split('.')[0];  // Remove milliseconds
    } else {
        // Create a new date in the correct format
        formattedDate = new Date().toISOString().split('.')[0];  // Remove milliseconds
    }
    return formattedDate;
}

// Функция сохранения страницы
function savePage(editor) {
    try {
        const content = editor.getContent();
        const title = document.getElementById('page-title').value;
        let path = document.querySelector('.file-path').textContent;
        const format = document.getElementById('meta-format').value;
        
        // Если это новая страница, используем пользовательское имя файла
        if (path === 'New Page') {
            const filename = document.getElementById('filename-input').value.trim();
            const extension = document.getElementById('file-extension').value;
            
            if (!filename) {
                alert("Пожалуйста, укажите имя файла для сохранения страницы");
                document.getElementById('filename-input').focus();
                return;
            }
            
            // Валидация имени файла (только буквы, цифры, дефисы и подчеркивания)
            if (!/^[a-zA-Z0-9\-_]+$/.test(filename)) {
                alert("Имя файла может содержать только буквы, цифры, дефисы и знаки подчеркивания");
                document.getElementById('filename-input').focus();
                return;
            }
            
            path = filename + extension;
        }
        
        if (!content) {
            console.error("Content is empty");
            alert("Error: Content is empty");
            return;
        }
        
        if (!path) {
            console.error("Path is empty");
            alert("Error: Path is empty");
            return;
        }
        
        // Format the date using our helper function
        const dateValue = document.getElementById('meta-date').value;
        const formattedDate = formatDateForISO(dateValue);
        
        const metadata = {
            title: title || "Untitled",
            date: formattedDate,
            author: document.getElementById('meta-author').value || "",
            tags: document.getElementById('meta-tags').value
                  ? document.getElementById('meta-tags').value.split(',').map(t => t.trim())
                  : [],
            format: format || "markdown",
            draft: document.getElementById('meta-draft').checked
        };
        
        // Создаем объект запроса
        const requestData = {
            path: path,
            content: content,
            metadata: metadata
        };
        
        // Преобразуем в JSON
        const jsonData = JSON.stringify(requestData);
        
        console.log("Saving page with path:", path);
        console.log("Content length:", content.length, "bytes");
        console.log("Metadata:", metadata);
        
        // Отправляем через fetch
        fetch('/admin/api/content', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: jsonData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    console.error("Response error text:", text);
                    throw new Error(`HTTP error! Status: ${response.status}, Message: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Response data:", data);
            if (data.success) {
                alert('Page saved successfully!');
                if (data.path && path === 'New Page') {
                    document.querySelector('.file-path').textContent = data.path;
                }
            } else {
                alert('Error saving page: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error saving page:', error);
            alert('Error saving page: ' + error.toString());
        });
    } catch (error) {
        console.error('Error in savePage function:', error);
        alert('Error preparing page for save: ' + error.toString());
    }
}

// Функция предпросмотра страницы
function previewPage(editor) {
    try {
        const content = editor.getContent();
        const title = document.getElementById('page-title').value;
        const format = document.getElementById('meta-format').value;
        
        // Format the date using our helper function
        const dateValue = document.getElementById('meta-date').value;
        const formattedDate = formatDateForISO(dateValue);
        
        const metadata = {
            title: title || "Untitled",
            date: formattedDate,
            author: document.getElementById('meta-author').value || "",
            tags: document.getElementById('meta-tags').value
                  ? document.getElementById('meta-tags').value.split(',').map(t => t.trim())
                  : [],
            format: format || "markdown",
            draft: document.getElementById('meta-draft').checked
        };
        
        fetch('/admin/api/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content: content,
                metadata: metadata
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! Status: ${response.status}, Message: ${text}`);
                });
            }
            return response.text();
        })
        .then(html => {
            const win = window.open('', 'preview', 'width=800,height=600');
            win.document.write(html);
            win.document.close();
        })
        .catch(error => {
            console.error('Error previewing page:', error);
            alert('Error previewing page: ' + error.message);
        });
    } catch (error) {
        console.error('Error in previewPage function:', error);
        alert('Error preparing page for preview: ' + error.message);
    }
}
</script>
{% endblock %} 